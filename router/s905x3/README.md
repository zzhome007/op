# OpenWrt for S905x3 ( X96-Max+, H96-Max-X3-Round & HK1-Box )

You can download the OpwnWrt for S905x3 firmware from [Actions](https://github.com/ophub/op/actions). From the ` Build OpenWrt for S905x3 `, Such as `openwrt_s905x3_${date}` Unzip to get the `***.img` file. Or download from [Releases](https://github.com/ophub/op/releases). Such as `openwrt_S905x3_${date}`. Then write the IMG file to the USB card/TF card  through software such as [balenaEtcher](https://www.balena.io/etcher/).

## Compilation instructions
1. Online automatic compilation: The script will regularly use the latest OpenWrt for phicomm-n1 firmware and modify ***` /boot/uEnv.txt `*** to build a compatible S905x3 series router.
2. Local manual compilation: First put the phicomm-n1 firmware into the ***` flippy `*** folder, and then run `sudo ./make ${firmware_key}`, the generated file is in the ***` out `*** directory.


## Firmware instructions

- `openwrt_hk1_*.img`: For X96-Max+(S905x3) / H96-Max-X3-Round(S905x3)
- `openwrt_x96_*.img`: For HK1-Box(S905x3)

Decompress the firmware and write it to a MicroSD card/TF card. Before starting the USB flash drive for the first time, use the adb tool to connect:
```shell script
adb connect 192.168.1.10       #change to box-ip
adb shell
su
reboot update
````
Then quickly insert the prepared USB card/TF card to start the openwrt for s905x3 firmware.

The firmware supports USB hard disk booting. You can also Install the OpenWrt firmware in the USB hard disk into the EMMC partition of S905x3, and start using it from EMMC.

If you use the scheme of writing emmc, you first need to Update the bootloader to support 1000M/s (X96-Max+ / H96-Max-X3-Round / HK1-Box universal HK1-box bootloader). you can restore the bootloader, restart it, and run the `Install OpenWrt` command again.
```shell script
dd if=/root/hk1box-bootloader.img of=/dev/mmcblk1 bs=1M
sync
reboot
```

Install OpenWrt: `Login in to openwrt` → `system menu` → `TTYD terminal` → input command: 
```shell script
#For X96-Max+(S905x3) / H96-Max-X3-Round(S905x3)
#Start from usb is to use meson-sm1-x96-max-plus-100m.dtb, Will change to meson-sm1-x96-max-plus.dtb after writing emmc.
n1-install.sh x96
reboot
```

```shell script
#For HK1-Box(S905x3)
n1-install.sh
reboot
```

Wait for the installation to complete. remove the USB hard disk, unplug/plug in the power again, reboot into EMMC.

Upgrading OpenWrt: `Login in to openwrt` → `system menu` → `file transfer` → upload to `/tmp/upgrade/xxx.img`, enter the `system menu` → `TTYD terminal` → input command: 
```shell script
n1-update.sh
reboot
```

Note: If used as a bypass gateway, you can add custom firewall rules as needed (Network → Firewall → Custom Rules):
```shell script
iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE        #If the interface is eth0.
iptables -t nat -I POSTROUTING -o br-lan -j MASQUERADE      #If the interface is br-lan bridged.
```

## Support firmware

Put phicomm_n1_firmware file into ${flippy_folder}. Support putting multiple phicomm_n1_firmware_*.img or phicomm_n1_firmware_*.zip files into compiling together.

```shell script
example: ~/op/router/s905x3/
 ├── flippy
 │   ├── phicomm_n1_firmware_01.img
 │   ├── phicomm_n1_firmware_02.img
 │   ├── phicomm_n1_firmware_more.img
 │   │
 │   └── or phicomm_n1_firmware.zip
 │
 └── make
 ```

## /boot/uEnv.txt:

```shell script
#Phicomm-N1
#FDT=/dtb/amlogic/meson-gxl-s905d-phicomm-n1.dtb
#Phicomm-N1 (thresh)
#FDT=/dtb/amlogic/meson-gxl-s905d-phicomm-n1-thresh.dtb
#
#X96-Max+ & H96-Max-X3-Round (100m) [tag: x96]
FDT=/dtb/amlogic/meson-sm1-x96-max-plus-100m.dtb
#X96-Max+ & H96-Max-X3-Round (1000m)
#FDT=/dtb/amlogic/meson-sm1-x96-max-plus.dtb
#
#HK1-Box [tag: hk1]
#FDT=/dtb/amlogic/meson-sm1-hk1box-vontar-x3.dtb
````

Method: Add # in front of the dtb file path of Phicomm N1, and remove the # in front of the firmware you need. 

## Detailed make compile command
- `sudo ./make all`: All S905x3 ( X96-Max+, H96-Max-X3-Round & HK1-Box ) OpenWrt firmware according to the default configuration firmware. This command is recommended.
- `sudo ./make x96`: Build the OpenWrt firmware of X96-Max+ & H96-Max-X3-Round according to the default configuration.
- `sudo ./make hk1`: Build the OpenWrt firmware of HK1-Box according to the default configuration.

## Configuration file function description

| Folder/file name | Features |
| ---- | ---- |
| flippy | Store Phicomm-N1 firmware, support multiple .img to compile together. Support the Phicomm-N1 firmware zip file generated by this github to be directly put in for compilation. |
| make | s905x3 OpenWrt firmware build script. |


## .github/workflow/build-openwrt-s905x3.yml related environment variable description

| Environment variable | Features |
| ---- | ---- |
| REPO_URL | Source code warehouse address |
| REPO_BRANCH | Source branch |
| FEEDS_CONF | Custom feeds.conf.default file name |
| CONFIG_FILE | Custom .config file name |
| DIY_P1_SH | Custom diy-part1.sh file name |
| DIY_P2_SH | Custom diy-part2.sh file name |
| SSH_ACTIONS | SSH connection Actions function. Default false |
| UPLOAD_BIN_DIR | Upload the bin directory (all ipk files and firmware). Default false |
| UPLOAD_FIRMWARE | Upload firmware catalog. Default true |
| UPLOAD_RELEASE | Upload firmware to release. Default true |
| UPLOAD_COWTRANSFER | Upload the firmware to CowTransfer.com. Default false |
| UPLOAD_WERANSFER | Upload the firmware to WeTransfer.com. Default failure |
| RECENT_LASTEST | maximum retention days for release, artifacts and logs in GitHub Release and Actions. |
| TZ | Time zone setting |
| secrets.GITHUB_TOKEN | 1. Personal center: Settings → Developer settings → Personal access tokens → Generate new token ( Name: GITHUB_TOKEN, Select: public_repo, Copy GITHUB_TOKEN's Value ). 2. Op code center: Settings → Secrets → New secret ( Name: RELEASES_TOKEN, Value: Paste GITHUB_TOKEN's Value ). |

## Firmware compilation parameters

| Option | Value |
| ---- | ---- |
| Target System | QEMU ARM Virtual Machine |
| Subtarget | ARMv8 multiplatform |
| Target Profile | Default |
| Target Images | squashfs |
| Utilities  ---> |  <*> install-program |
| LuCI -> Applications | in the file: .config |

## Firmware information

| Name | Value |
| ---- | ---- |
| Default IP | 192.168.1.1 |
| Default username | root |
| Default password | password |
| Default WIFI name | OpenWrt |
| Default WIFI password | none |

